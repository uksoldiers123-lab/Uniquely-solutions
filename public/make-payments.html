<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Unuity Solutions â€” Make a Payment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Include Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    /* Minimal styling for a drop-in patch; replace with your design tokens */
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; color: #333; }
    header, nav { background: #111; color: #fff; padding: 12px 20px; }
    header a, nav a { color: #fff; text-decoration: none; margin-right: 14px; }
    .container { max-width: 800px; margin: 40px auto; padding: 0 20px; }
    .field { margin-bottom: 12px; }
    label { display: block; margin-bottom: 6px; }
    input, select { width: 100%; padding: 8px; box-sizing: border-box; }
    #card-element { padding: 12px; border: 1px solid #ccc; border-radius: 6px; background: #fff; }
    #card-errors { color: #e00; min-height: 1em; }
    button { padding: 12px 16px; background: #6772e5; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    .status { margin-top: 16px; font-weight: bold; }
  </style>
</head>
<body>
  <!-- Header/Nav (updated to include Make a Payment) -->
  <header>
    <nav>
      <a href="/index.html">Home</a>
      <a href="/services.html">Services</a>
      <a href="/partners.html">Partners</a>
      <a href="/public/make-payments.html" class="active">Make a Payment</a>
      <!-- Add/keep other existing links as needed -->
      <a href="/dashboard.html">Dashboard</a>
      <span style="float:right;">Unuity Solutions</span>
    </nav>
  </header>

  <div class="container">
    <h1>Make a Payment</h1>
    <p>Secure checkout with Stripe Card. Enter client details and pay a specific client.</p>

    <form id="payment-form" autocomplete="off">
      <div class="field">
        <label for="clientCode">Client Code</label>
        <input id="clientCode" name="clientCode" placeholder="e.g., CLI-001" required />
      </div>

      <div class="field">
        <label for="amount">Amount (in cents)</label>
        <input id="amount" name="amount" type="number" placeholder="1000 for $10.00" required />
      </div>

      <div class="field">
        <label for="currency">Currency</label>
        <select id="currency" name="currency">
          <option value="usd" selected>USD</option>
          <option value="eur">EUR</option>
          <option value="cad">CAD</option>
        </select>
      </div>

      <div class="field">
        <label>Billing details</label>
        <input id="name" placeholder="Name" />
        <input id="email" type="email" placeholder="Email" />
        <input id="address" placeholder="Address (optional)" />
      </div>

      <div class="field">
        <label>Card</label>
        <div id="card-element"><!-- Stripe CardElement will mount here --></div>
        <div id="card-errors" role="alert"></div>
      </div>

      <button id="submit">Pay now</button>
    </form>

    <div id="payment-status" class="status" aria-live="polite"></div>
  </div>

  <script>
    // Replace with your Stripe publishable key
    const STRIPE_PUBLISHABLE_KEY = 'pk_live_51Rv1X3By3HHUeuve2mwl2HJqUYgFuSa2xWM6AwjbcM10Ts6jqdsrtT5RZ9DkK754BEHQ68jqKZ0w0N32zQHLT9Xr007tOweb2G';
    const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

    let card;
    function mountCard() {
      const elements = stripe.elements();
      card = elements.create('card');
      card.mount('#card-element');
      card.on('change', (ev) => {
        const display = document.getElementById('card-errors');
        if (ev.error) {
          display.textContent = ev.error.message;
        } else {
          display.textContent = '';
        }
      });
    }

    async function createPaymentIntent(payload) {
      const resp = await fetch('/api/create-payment-intent-for-client', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      return resp.json();
    }

    document.addEventListener('DOMContentLoaded', () => {
      mountCard();

      const form = document.getElementById('payment-form');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const clientCode = document.getElementById('clientCode').value;
        const amount = parseInt(document.getElementById('amount').value, 10);
        const currency = (document.getElementById('currency').value || 'usd').toLowerCase();

        const billing_details = {
          name: document.getElementById('name').value,
          email: document.getElementById('email').value,
          address: document.getElementById('address').value
        };

        if (!clientCode || !Number.isInteger(amount)) {
          document.getElementById('payment-status').textContent = 'Please enter valid Client Code and Amount';
          return;
        }

        // Create PaymentIntent for this client
        const payload = {
          clientCode,
          amount,
          currency,
          billing_details
        };

        try {
          const result = await createPaymentIntent(payload);

          if (result && result.paymentIntent) {
            const { clientSecret, paymentIntentId } = result.paymentIntent;
            // Confirm card payment
            const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
              payment_method: {
                card: card,
                billing_details: billing_details
              }
            });

            if (error) {
              document.getElementById('payment-status').textContent = 'Payment failed: ' + error.message;
            } else if (paymentIntent && paymentIntent.status === 'succeeded') {
              document.getElementById('payment-status').textContent = 'Payment succeeded: ' + paymentIntent.id;
            } else {
              document.getElementById('payment-status').textContent = 'Payment status: ' + (paymentIntent && paymentIntent.status);
            }
          } else {
            document.getElementById('payment-status').textContent = 'Failed to create payment intent';
          }
        } catch (err) {
          document.getElementById('payment-status').textContent = 'Error: ' + (err?.message || err);
        }
      });
    });
  </script>
</body>
</html>
